name: Build and Release Android APK

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # NEW: Cache Global NPM packages to speed up Bubblewrap CLI installation
      - name: Cache NPM Global
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # NEW: Cache Gradle dependencies (This saves the most time!)
      - name: Cache Gradle Packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install Bubblewrap CLI
        run: npm install -g @bubblewrap/cli

      - name: Configure Bubblewrap (skip interactive JDK/SDK prompts)
        run: |
          mkdir -p ~/.bubblewrap
          cat > ~/.bubblewrap/config.json << EOF
          {
            "jdkPath": "$JAVA_HOME",
            "androidSdkPath": "$ANDROID_HOME"
          }
          EOF
          echo "Bubblewrap config:"
          cat ~/.bubblewrap/config.json
          bubblewrap doctor || true

      - name: Accept Android SDK Licenses
        run: yes | sdkmanager --licenses || true

      - name: Generate Keystore
        run: |
          keytool -genkey -v \
            -keystore ${{ github.workspace }}/android.keystore \
            -alias android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android123 \
            -keypass android123 \
            -dname "CN=MandarinSprint, OU=Learning, O=Sprint, L=App, S=Global, C=US"

      - name: Generate twa-manifest.json
        run: |
          mkdir -p twa-output
          cat <<EOF > twa-output/twa-manifest.json
          {
            "packageId": "com.mandarinsprint.twa",
            "host": "ai-sprint-mandarin-part-1.vercel.app",
            "name": "Mandarin Sprint",
            "launcherName": "Mandarin Sprint",
            "appVersionCode": ${{ github.run_number }},
            "appVersionName": "1.0.${{ github.run_number }}",
            "themeColor": "#FFFFFF",
            "navigationColor": "#FFFFFF",
            "backgroundColor": "#FFFFFF",
            "startUrl": "/",
            "display": "standalone",
            "iconUrl": "https://ai-sprint-mandarin-part-1.vercel.app/icon.png",
            "maskableIconUrl": "https://ai-sprint-mandarin-part-1.vercel.app/icon.png",
            "splashScreenFadeOutDuration": 300,
            "enableNotifications": true,
            "shortcuts": [],
            "generatorApp": "bubblewrap-cli",
            "fallbackType": "customtabs",
            "features": {},
            "alphaDependencies": {
              "enabled": false
            },
            "signingKey": {
              "path": "${{ github.workspace }}/android.keystore",
              "alias": "android"
            }
          }
          EOF

      - name: Build APK with Bubblewrap
        env:
          BUBBLEWRAP_KEYSTORE_PASSWORD: android123
          BUBBLEWRAP_KEY_PASSWORD: android123
        working-directory: ./twa-output
        run: |
          yes | bubblewrap build --skipPwaValidation

      - name: List build outputs
        run: |
          echo "=== Build outputs ==="
          find twa-output -name "*.apk" -o -name "*.aab" | head -20

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mandarin-sprint-apk
          path: |
            twa-output/app-release-signed.apk
            twa-output/app-release-bundle.aab
          if-no-files-found: error

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            twa-output/app-release-signed.apk
            twa-output/app-release-bundle.aab
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## üì± Android App (${{ github.ref_name }})

            This APK was built using Google's Bubblewrap CLI from the PWA hosted at:
            https://ai-sprint-mandarin-part-1.vercel.app/

            ### ‚ö†Ô∏è Note:
            This is a debug-signed build for testing. You may need to bypass
            "Play Protect" warnings during installation.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
